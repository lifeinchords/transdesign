// jquery.jparallax.js
// 1.0
// Stephen Band
//
// Project and documentation site:
// webdev.stephband.info/jparallax/
//
// Repository:
// github.com/stephband/jparallax
//
// Dependencies:
// jquery.event.frame
// webdev.stephband.info/events/frame/
(function(e,t){function f(e){return this.lib[e]}function l(e){return typeof e=="boolean"?e:!!parseFloat(e)}function c(e){return s.percent.exec(e)?parseFloat(e)/100:e}function h(e,t,n,r){var i=[e,t];this.ontarget=!1,this.decay=n,this.pointer=r||[.5,.5],this.update=function(e,t){var n,r;if(this.ontarget)this.pointer=e;else if((!i[0]||u(e[0]-this.pointer[0])<t[0])&&(!i[1]||u(e[1]-this.pointer[1])<t[1]))this.ontarget=!0,this.pointer=e;else{n=[],r=2;while(r--)i[r]&&(n[r]=e[r]+this.decay*(this.pointer[r]-e[r]));this.pointer=n}}}function p(t,r){var i=this,s=t instanceof e?t:e(t),o=[l(r.xparallax),l(r.yparallax)],u=0,a;this.pointer=[0,0],this.active=!1,this.activeOutside=r&&r.activeOutside||!1,this.update=function(e){var t=this.pos,n=this.size,r=[],i=2;if(u>0){u===2&&(u=0,a&&(e=a));while(i--)o[i]&&(r[i]=(e[i]-t[i])/n[i],r[i]=r[i]<0?0:r[i]>1?1:r[i]);this.active=!0,this.pointer=r}else this.active=!1},this.updateSize=function(){var e=s.width(),t=s.height();i.size=[e,t],i.threshold=[1/e,1/t]},this.updatePos=function(){var e=s.offset()||{left:0,top:0},t=parseInt(s.css("borderLeftWidth"))+parseInt(s.css("paddingLeft")),n=parseInt(s.css("borderTopWidth"))+parseInt(s.css("paddingTop"));i.pos=[e.left+t,e.top+n]},e(window).bind("resize."+n,i.updateSize).bind("resize."+n,i.updatePos),s.bind("mouseenter."+n,function(e){u=1}).bind("mouseleave."+n,function(e){u=2,a=[e.pageX,e.pageY]}),this.updateSize(),this.updatePos()}function d(e,n){var r=[],o=[],u=[],a=[];this.update=function(t){var n=[],i,s,f=2,l={};while(f--)o[f]&&(n[f]=o[f]*t[f]+u[f],r[f]?(i=a[f],s=n[f]*-1):(i=n[f]*100+"%",s=n[f]*this.size[f]*-1),f===0?(l.left=i,l.marginLeft=s):(l.top=i,l.marginTop=s));e.css(l)},this.setParallax=function(e,f,l,h){var p=[e||n.xparallax,f||n.yparallax],d=[l||n.xorigin,h||n.yorigin],v=2,m={};while(v--)r[v]=s.px.test(p[v]),typeof d[v]=="string"&&(d[v]=d[v]===t?1:i[d[v]]||c(d[v])),r[v]?(o[v]=parseInt(p[v]),u[v]=d[v]*(this.size[v]-o[v]),a[v]=d[v]*100+"%"):(o[v]=p[v]===!0?1:c(p[v]),u[v]=o[v]?d[v]*(1-o[v]):0)},this.getPointer=function(){var t=e.offsetParent(),n=e.position(),i=[],s=[],a=2;while(a--)r[a]?i[a]=0:i[a]=n[a===0?"left":"top"]/(t[a===0?"outerWidth":"outerHeight"]()-this.size[a]),s[a]=(i[a]-u[a])/o[a];return s},this.setSize=function(t,n){this.size=[t||e.outerWidth(),n||e.outerHeight()]},this.setSize(n.width,n.height),this.setParallax(n.xparallax,n.yparallax,n.xorigin,n.yorigin)}function v(t){var r=e(this),i=t.data.global||t.data,s=t.data.local||r.data(n),u=i.port,f=i.mouse,l=s.mouse,c=i.timeStamp!==t.timeStamp;c&&(i.timeStamp=t.timeStamp,u.update(a),(u.active||!f.ontarget)&&f.update(u.pointer,u.threshold)),l?(l.update(s.freeze?s.freeze.pointer:u.pointer,u.threshold),l.ontarget&&(delete s.mouse,s.freeze&&r.unbind(o).addClass(i.freezeClass)),f=l):f.ontarget&&!u.active&&r.unbind(o),s.layer.update(f.pointer)}var n="parallax",r={mouseport:"body",xparallax:!0,yparallax:!0,xorigin:.5,yorigin:.5,decay:.66,frameDuration:30,freezeClass:"freeze"},i={left:0,top:0,middle:.5,center:.5,right:1,bottom:1},s={px:/^\d+\s?px$/,percent:/^\d+\s?%$/},o="frame."+n,u=Math.abs,a=[0,0];f.lib=i,e.fn[n]=function(i){var s=e.extend({},e.fn[n].options,i),u=arguments,a=this,f=[];if(t===e.event.special.frame)throw"jquery.parallax requires jquery.event.frame.";return s.mouseport instanceof e||(s.mouseport=e(s.mouseport)),s.port=new p(s.mouseport,s),s.mouse=new h(l(s.xparallax),l(s.yparallax),s.decay),s.mouseport.bind("mouseenter",function(t){var r=a.length,i;s.mouse.ontarget=!1;while(r--)i=a[r],e.data(i,n).freeze||e.event.add(this,o,v,{global:s,local:f[r]})}),a.each(function(i){var a=e(this),p=u[i+1]?e.extend({},s,u[i+1]):s,m=new d(a,p),g={layer:m,mouse:new h(l(p.xparallax),l(p.yparallax),p.decay,m.getPointer())};a.data(n,g),f.push(g),e.event.add(this,"freeze",function(n){var r=e(this),i=n.data.global,s=n.data.local,u=s.mouse||s.freeze||i.mouse,a=a=[n.x===t?u.pointer[0]:c(n.x),n.y===t?u.pointer[1]:c(n.y)],f=n.decay;s.freeze={pointer:a},s.mouse=new h(l(i.xparallax),l(i.yparallax),i.decay,u.pointer),f!==t&&(s.mouse.decay=f),e.event.add(this,o,v,i)},{global:s,local:g}),e.event.add(this,"unfreeze",function(n){var i=e(this),s=n.data.global,u=n.data.local,a=n.decay,f;if(!u.freeze)return;f=u.mouse?u.mouse.pointer:u.freeze.pointer,u.mouse=new h(l(s.xparallax),l(s.yparallax),s),u.mouse.pointer=f,a!==t&&(u.mouse.decay=a),delete u.freeze,i.removeClass(r.freezeClass),e.event.add(this,o,v,s)},{global:s,local:g})})},e.fn[n].options=r,e(document).ready(function(){e(document).mousemove(function(e){a=[e.pageX,e.pageY]})})})(jQuery);